<div class="row">
  <form id="login" name="item" style="display: block;">
    <div class="large-8 columns">
      管理者用ログイン
    </div>
    <div class="large-8 columns">
      <label>メールアドレス:</label>
      <input name="mail" type="email" value="{{mail}}" required>
    </div>
    <div class="large-8 columns">
      <label>パスワード:</label>
      <input type="password" name="password" required>
    </div>
    <div class="large-8 columns">
      <input name="id" type="hidden" value="{{id}}">
      <a id="login" href="#" class="small button">ログイン</a>
    </div>
  </form>
  <script type="application/javascript">
    $(function() {
      $("#login").off("click");
      $("#login").on("click", function(){
        var form = $("#item");
        var formData = new FormData();
        var item = {
          id: form.find("[name=id]").val(),
          name: form.find("[name=name]").val(),
          description: form.find("[name=description]").val(),
          price: form.find("[name=price]").val()
        };
        formData.append("item", JSON.stringify(item));
        $.map( $(":file").get(0).files, function(image, idx){
          formData.append("images["+idx+"]", image);
        })
        $.ajax({
          async: true,
//          xhr : function(){
//            var XHR = $.ajaxSettings.xhr();
//            if(XHR.upload){
//              XHR.upload.addEventListener('progress',function(e){
//                var progre = parseInt(e.loaded/e.total*10000)/100 ;
//                console.log(progre+"%") ;
//                $("#progress_bar").width(parseInt(progre/100*300*100)/100+"px");
//                $("#progress_bar").height("30px");
//                $("#progress_bar").html(progre+"%");
//              }, false);
//            }
//            return XHR;
//          },
          url: "/manage/item/"+item.id,
          type: "post",
//          data: {item: JSON.stringify(item)}
          data: formData,
          contentType: "multipart/form-data",
          processData: false
        }).done(function( msg ) {
          console.log( msg );
          $("#output").append(msg);
        });
      });
    });
  </script>
</div>
